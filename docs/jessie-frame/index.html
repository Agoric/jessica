<!DOCTYPE html>
<html>
    <head>
        <title>Jessica Browser</title>
    </head>
    <body>
        <style type="text/css">
        #sourceText {
            width: 100%;
        }
        </style>
        <h1><span style="color: red" id="insecure">INSECURE</span> Browser-Based Jessica</h1>

        <p>Write your Jessie code below:</p>
        <textarea id="sourceText" rows="20">
// Use Jessie's main deps to run the program.
const main = immunize((deps) => {
    deps.writeOutput('-', 'Hello, world!\n');
});
export default immunize(main);</textarea>
        <button onclick="doRun(sourceText.value, outputPre)">Run</button>
        
        <pre id="outputPre">
        </pre>

<script type="text/javascript" src="../ses.umd.js"></script>
        <script type="text/javascript" src="../jessica.js"></script>
        <script type="text/javascript">
let evaluator;
if (typeof SES !== 'undefined') {
    // Use SES if available.
    const r = SES.makeSESRootRealm({});
    evaluator = (src) => r.evaluate(src, {...jessica.globals, $h_define});
    insecure.style.color = 'green';
    insecure.textContent = 'SECURE';
} else {
    evaluator = (src) => jessica.globals.confine(src, {...jessica.globals, $h_define});
    alert('WARNING: Secure Javascript is not available!\n\nUnprotected GLOBAL Scope available to Jessie.');
}
const doRun = (sourceText, output) => {
    output.textContent = '';
    const parameters = {
        sourceType: 'jessie',
        target: 'jessie-frame',
        targetType: 'function',
    };

    // Make a confined file writer.
    const writeOutput = (fname, str) => {
        if (fname !== '-') {
            slog.error`Cannot write to ${{fname}}: must be -`;
        }
        output.textContent += str;
    };

    const deps = {
        writeOutput,
    };
    jessica.translate(sourceText, parameters)
        .then(translated => evaluator(translated.translatedText))
        .then(result => {
            // Get the default export.
            const main = result.default;

            // Execute as main, if a function.
            const val = typeof main === 'function' ? main(deps, []) : main;

            // ... maybe Print.
            if (val !== undefined) {
                writeOutput('-', val);
            }
        })
        .catch(e => {
            writeOutput('-', e);
            throw e;
        });
};

const loadingMap = new Map();
const $h_define = (imports, factory) => {
    const parameters = {
        sourceType: 'jessie',
        target: 'jessie-frame',
        targetType: 'function',
    };
    const importPromises = imports.map((mod, i) => {
        const uri = '/' + mod;
        let promise = loadingMap.get(mod);
        if (!promise) {
            promise = fetch(uri)
                .then(res => {
                    if (res.ok) {
                        return res.text();
                    }
                    throw Error('Cannot load ' + uri);
                })
                .then(text => jessica.translate(text, parameters))
                .then(translated => evaluator(translated.translatedText));
            loadingMap.set(promise);
        }
        return promise;
    });
    return Promise.all(importPromises).then(ps =>
        factory.apply(undefined, ps));
};
</script>
    </body>
</html>
